pipeline {
    agent any

    parameters {
        choice(name: 'ACTION', choices: ['create', 'destroy'], description: 'Select whether to create or destroy the S3 bucket')
        string(name: 'BUCKET_NAME', defaultValue: 'my-custom-bucket-from-jenkins', description: 'Name of the S3 bucket')
    }

    environment {
        TF_VAR_bucket_name = "${params.BUCKET_NAME}"
    }

    stages {
        stage('Clone Terraform Repo') {
            steps {
                echo "ðŸ“¥ Cloning Terraform Repo..."
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                dir('s3') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Plan & Apply/Destroy') {
            steps {
                dir('s3') {
                    script {
                        if (params.ACTION == 'create') {
                            echo "Creating bucket: ${params.BUCKET_NAME}"
                            sh '''
                                terraform plan
                                terraform apply --auto-approve
                            '''
                        } else {
                            echo "Destroying bucket: ${params.BUCKET_NAME}"
                            sh '''
                                terraform destroy --auto-approve
                            '''
                        }
                    }
                }
            }
        }

        stage('Confirmation') {
            steps {
                script {
                    if (params.ACTION == 'create') {
                        echo "S3 bucket '${params.BUCKET_NAME}' created successfully."
                    } else {
                        echo "S3 bucket '${params.BUCKET_NAME}' destroyed successfully."
                    }
                }
            }
        }
    }
}
