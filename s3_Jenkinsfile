pipeline {
    agent any
    parameters {
        string(name: 'BUCKET_NAME', defaultValue: 'my-default-bucket', description: 'Enter the S3 bucket name')
    }

    stages {
        stage('Clone Terraform Repo') {
            steps {
                echo 'Cloning S3 Terraform module'
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/main']],
                          extensions: [],
                          userRemoteConfigs: [[url: 'https://github.com/riteshbehal/TerraForm.git']]
                ])
            }
        }

        stage('Terraform Apply (S3)') {
            steps {
                sh """
                    cd s3
                    terraform init
                    terraform plan -var="bucket_name=${params.BUCKET_NAME}"
                    terraform apply -var="bucket_name=${params.BUCKET_NAME}" --auto-approve
                """
            }
        }

        stage('Destroy S3 Bucket?') {
            steps {
                input message: 'Destroy the S3 bucket?'
            }
        }

        stage('Terraform Destroy (S3)') {
            steps {
                sh """
                    cd s3
                    terraform destroy -var="bucket_name=${params.BUCKET_NAME}" --auto-approve
                """
            }
        }
    }
}
